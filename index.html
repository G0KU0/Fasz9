<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <title>Saját IPTV Lejátszó</title>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <style>
        body { font-family: sans-serif; display: flex; margin: 0; height: 100vh; background: #1a1a1a; color: white; }
        #sidebar { width: 300px; border-right: 1px solid #444; overflow-y: auto; padding: 10px; }
        #main { flex-grow: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .channel-item { padding: 10px; border-bottom: 1px solid #333; cursor: pointer; transition: 0.2s; }
        .channel-item:hover { background: #333; }
        video { width: 90%; max-height: 80%; border: 2px solid #000; box-shadow: 0 0 20px rgba(0,0,0,0.5); }
        h3 { margin-top: 0; color: #00d4ff; }
    </style>
</head>
<body>

<div id="sidebar">
    <h3>Csatornák</h3>
    <div id="channelList">Betöltés...</div>
</div>

<div id="main">
    <h2 id="currentChannel">Válassz csatornát!</h2>
    <video id="video" controls></video>
</div>

<script>
    const video = document.getElementById('video');
    const channelList = document.getElementById('channelList');
    const currentChannelTitle = document.getElementById('currentChannel');
    const hls = new Hls();

    // 1. Csatornalista letöltése és feldolgozása
    fetch('http://localhost:3000/playlist')
        .then(res => res.text())
        .then(data => {
            const lines = data.split('\n');
            channelList.innerHTML = '';
            
            for (let i = 0; i < lines.length; i++) {
                if (lines[i].startsWith('#EXTINF')) {
                    const info = lines[i];
                    const url = lines[i + 1]?.trim();
                    const name = info.split(',')[1] || "Ismeretlen adás";

                    if (url && url.startsWith('http')) {
                        const div = document.createElement('div');
                        div.className = 'channel-item';
                        div.innerText = name;
                        div.onclick = () => playChannel(url, name);
                        channelList.appendChild(div);
                    }
                }
            }
        });

    // 2. Lejátszás funkció a proxyn keresztül
    function playChannel(url, name) {
        currentChannelTitle.innerText = "Most megy: " + name;
        const proxiedUrl = `http://localhost:3000/proxy?url=${encodeURIComponent(url)}`;

        if (Hls.isSupported()) {
            hls.loadSource(proxiedUrl);
            hls.attachMedia(video);
            hls.on(Hls.Events.MANIFEST_PARSED, () => video.play());
        } else {
            video.src = proxiedUrl;
            video.play();
        }
    }
</script>
</body>
</html>
